#!/usr/bin/env python3

import argparse
import sys
import os
import curses
import curses.textpad

from grimoire.sequence import DNA
from grimoire.feature_table import FeatureTable
from grimoire.io import FASTA_stream, GFF_file
from grimoire.genome import gff_to_feature

## Command line stuff ##

extended_help = """
%(prog)s is a very simple terminal-based genome browser designed for testing
and debugging seqeunce analysis algorithms. It loads all of the
sequences and features into memory and doesn't do any coordinate
indexing. It is therefore not suitable for complete genomes.
"""

parser = argparse.ArgumentParser(
	description='Terminal-based genome browser.',
	formatter_class=argparse.RawDescriptionHelpFormatter,
	epilog=extended_help)
parser.add_argument('fasta', nargs=1, help='a fasta file')
parser.add_argument('gff', nargs='+', help='some gff (or other) files')
arg = parser.parse_args()

#############
## Globals ##
#############

D = []  # dnas: indexed in order of FASTA file
G = []  # genes: indexed by fasta# then gene#
B = { # browser state
	'dna':None, # current dna object number
	'beg':None, # begin coordinate of viewer window
	'end':None, # end coordinate of viewer window
	'pos':None, # position of the current focus
	'foc':None, # identity of the current focus
	'cx':None,  # cursor x position
	'cy':None,  # cursor y position
}

KANDI_HELP = """
 KANDI help screen

 General
 + The top of the screen shows current location
 + The bottom of the screen shows menu items

 Selector
 + Use the up/down arrow keys to choose a sequence
 + Use the return key to select a sequence for browsing

 Browser
 + Use the arrow keys to move the cusor around
 + Top of screen displays feature information
 + Use the +/- keys to zoom
 + Add the shift key to make bigger steps (both left/right and zoom)
 + Use the return key to set zoom on a feature under cursor
"""

def help_screen(stdscr):
	curses.curs_set(0)

	while (1):
		stdscr.clear()
		H, W = stdscr.getmaxyx()
		
		# content
		stdscr.addstr(2, 1, KANDI_HELP)
	
		# location & menu
		loc = '{}:{}-{}'.format(B['dna'].name, B['beg'], B['end'])
		stdscr.addstr(0, 0, loc, curses.color_pair(1))
		stdscr.addstr(H-1, 0, '(s)elector (v)iewer (q)uit',
			curses.color_pair(1))

		# action
		k = stdscr.getch()
		if   k == ord('s'): select_screen(stdscr)
		elif k == ord('v'): view_screen(stdscr)
		elif k == ord('q'): sys.exit(0)
		
		stdscr.refresh()

def select_screen(stdscr):
	curses.curs_set(2)
	top = 4
	bot = top + len(D) -1
	cx = 3
	cy = top
	stdscr.move(cy, cx)
	k = None

	while (1):
		stdscr.clear()
		H, W = stdscr.getmaxyx()
		
		# content
		stdscr.addstr(2, 1, 'KANDI chromosome selector')	
		for i in range(len(D)):
			stdscr.addstr(4 + i, 4, D[i].name)
	
		# location & menu
		loc = '{}:{}-{}'.format(B['dna'].name, B['beg'], B['end'])
		stdscr.addstr(0, 0, loc, curses.color_pair(1))
		stdscr.addstr(H-1, 0, '(b)rowser (h)elp (q)uit', curses.color_pair(1))

		# action
		if   k == ord('h'): help_screen(stdscr)
		elif k == ord('v'): view_screen(stdscr)
		elif k == ord('q'): sys.exit(0)
		elif k == 258: cy = cy + 1
		elif k == 259: cy = cy - 1
		elif k == 10:
			init_chrom(cy - top)
			view_screen(stdscr)
		
		if cy < top: cy = top
		if cy > bot: cy = bot
		stdscr.move(cy, cx)
		stdscr.refresh()
		k = stdscr.getch()
		
def view_screen(stdscr):
	curses.curs_set(2)
	H, W = stdscr.getmaxyx()
	cx = int(W/2)
	cy = int(H/2)
	stdscr.move(cy, cx)
		
	k = None
	while (1):
		stdscr.clear()
		H, W = stdscr.getmaxyx()
		scale = len(STATE['seq']) / W # scale
		
		mat = []
		max_rows = H-2
		for y in range(max_rows):
			mat.append([])
			for x in range(W):
				mat[y].append([])
				mat[y][x] = None

		for gene in STATE['g1']:
			c = 5 # color
			if gene.strand == '-': c = 7
			beg, end = None, None
			if gene.beg > STATE['beg'] and gene.beg < STATE['end']:
				beg = int(gene.beg / scale)
			if gene.end > STATE['beg'] and gene.end < STATE['end']:
				end = int(gene.end / scale)
			if not (beg or end): continue

			for y in range(max_rows):
				if beg == end:
					if mat[y][beg] == None:
						mat[y][beg] = gene
						stdscr.addstr(y+2, beg, '|', curses.color_pair(c))
						break
				elif beg and end:
					clear = True
					for x in range (beg, end+1):
						if mat[y][x] != None:
							clear = False
							break
					if not clear: continue
					for x in range (beg, end+1): mat[y][x] = gene
					stdscr.addstr(y+2, beg, '[', curses.color_pair(c))
					for i in range (beg+1, end):
						stdscr.addstr(y+2, i, '=', curses.color_pair(c))
					stdscr.addstr(y+2, end, ']', curses.color_pair(c))
					break
				elif beg:
					pass
				elif end:
					pass
			
		# location & menu
		loc = '{}:{}-{} {}'.format(
			STATE['id'],STATE['beg'], STATE['end'], STATE['pos'])
		stdscr.addstr(0, 0, loc, curses.color_pair(1))
		stdscr.addstr(H-1, 0, '(s)elector (h)elp (q)uit',
			curses.color_pair(1))

		# action
		if   k == ord('h'): help_screen(stdscr)
		elif k == ord('s'): select_screen(stdscr)
		elif k == ord('q'): sys.exit(0)
		elif k == 258: cy = cy + 1    # arrow down
		elif k == 259: cy = cy - 1    # arrow up
		elif k == 261: cx = cx + 1    # arrow right
		elif k == 402: cx += int(W/3) # shift-arrow right
		elif k == 260: cx = cx - 1    # arrow left
		elif k == 393: cx -= int(W/3) # shift-arrow left
		elif k == 10:  cx = int(W/2)  # re-center cursor
		elif k == ord('-'): zoom(-1)
		elif k == ord('_'): zoom(-5)
		elif k == ord('='): zoom(+1)
		elif k == ord('+'): zoom(+5)
		
		if cx < 0:   cx = 0
		if cx > W-1: cx = W-2
		if cy < 1:   cy = 1
		if cy > H-2: cy = H-2
		
		stdscr.move(cy, cx)
		stdscr.refresh()
		k = stdscr.getch()

def init_browser(stdscr):

	# initialize curses	and begin on the help page
	curses.start_color()
	curses.init_pair(1, curses.COLOR_BLACK, curses.COLOR_WHITE)
	curses.init_pair(2, curses.COLOR_RED, curses.COLOR_BLACK)
	curses.init_pair(3, curses.COLOR_YELLOW, curses.COLOR_BLACK)
	curses.init_pair(4, curses.COLOR_GREEN, curses.COLOR_BLACK)
	curses.init_pair(5, curses.COLOR_CYAN, curses.COLOR_BLACK)
	curses.init_pair(6, curses.COLOR_BLUE, curses.COLOR_BLACK)
	curses.init_pair(7, curses.COLOR_MAGENTA, curses.COLOR_BLACK)
	help_screen(stdscr)

def init_chrom(idx):

	# when a new chromosome is chosen, reset the zoom and cursor
	B['dna'] = D[idx]
	B['beg'] = 1
	B['end'] = len(D[idx].seq)
	B['pos'] = int(len(D[idx].seq) / 2)
	B['foc'] = None
	B['cx'] = None
	B['cy'] = None
	
if __name__ == '__main__':

	# read sequences
	fasta = FASTA_stream(arg.fasta[0])
	for entry in fasta:
		D.append(DNA(name=entry.id, seq=entry.seq))
	
	# read features and build genes
	for i in range(len(arg.gff)):
		G.append([])
		gf = GFF_file(file=arg.gff[i])
		for dna in D:
			gffs = gf.get(chrom=dna.name)
			features = []
			for gff in gffs:
				features.append(gff_to_feature(dna, gff))	
			ft = FeatureTable(dna=dna, features=features)
			genes = ft.build_genes()
			G[i].append(genes)

	# initialize for first sequence
	init_chrom(0)

	# start the curses session
	curses.wrapper(init_browser)

